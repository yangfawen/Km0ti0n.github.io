<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <title>Kizunaai</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <link href="css/jquery-accordion-menu.css" rel="stylesheet" type="text/css" />
    <link href="css/font-awesome.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="css/index.css">
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <style>
    body {
        font-family: "Microsoft YaHei" ! important;
        background-color: #fff;
        color: #000;
        margin: 0;
        overflow: hidden;
    }

    #info {
        color: #000;
        position: fixed;
        top: 10px;
        width: 100%;
        text-align: center;
        display: block;
    }

    #info a,
    .button {
        color: #f00;
        font-weight: bold;
        text-decoration: underline;
        cursor: pointer
    }

    #hover {
        background-color: #DDE0DF;
        position: absolute;
        top: 0px;
        left: 0px;
        height: 100%;
        width: 100%;
    }

    .hover {
        display: inline;
    }

    .innertext {
        position: relative;
        top: 30%;
        left: 45%;
    }

    </style>
</head>

<body>
    <div id="hover" class="in-text">
        <span class="innertext"><span><h3 id="text"> Loading</h3></span></span>
    </div>
    <div class="wrapper" id="ct">
        <div class="menu-wrap">
            <div id="jquery-accordion-menu" class="jquery-accordion-menu red">
                <div class="jquery-accordion-menu-header">Kizuna AI</div>
                <ul id="demo-list">
                    <li><a href="#">模型</a><span class="jquery-accordion-menu-label">5</span>
                        <ul class="submenu" id="model_choise">
                        </ul>
                    </li>
                    <!--<li><a href="#">动作</a><span class="jquery-accordion-menu-label">5</span>
                        <ul class="submenu" id="vmd_choise">
                        </ul>
                    </li>-->
                </ul>
            </div>
            <button class="close-button" id="close-button">Close Menu</button>
        </div>
        <button class="menu-button" id="open-button">Open Menu</button>
        <div class="content-wrap" id="box">
    </div>
        <!-- /content-wrap -->
    </div>
    <script src="js/build/three.js"></script>
    <script src="js/build/mmdparsers.js"></script>
    <script src="js/libs/ammo.js"></script>
    <script src="js/loaders/TGALoader.js"></script>
    <script src="js/loaders/MMDLoader.js"></script>
    <script src="js/effects/OutlineEffect.js"></script>
    <script src="js/animation/CCDIKSolver.js"></script>
    <script src="js/animation/MMDPhysics.js"></script>
    <script src="js/controls/OrbitControls.js"></script>
    <script src="js/Detector.js"></script>
    <script src="js/libs/stats.min.js"></script>
    <script src="js/libs/dat.gui.min.js"></script>
    <script src="js/classie.js"></script>
    <script src="js/index.js"></script>
    <script type="text/javascript">
    //初始化开始
    var container, stats;
    var mesh, camera, scene, renderer, effect;
    var helper, ikHelper, physicsHelper;
    var mouseX = 0,
        mouseY = 0;
    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2;
    var clock = new THREE.Clock();
    var audioplayer;
    var modelFile; //模型文件
    var vmdFiles; //动作文件
    var audioFiles; //声音文件
    var bgFiles; //背景文件
    var onLoadPresent; //全局加载进度
    modelFile = 'model/kizunaai/kizunaai.pmx';
    vmdFiles = ['vmd/pinkcat.vmd'];
    audioFiles = 'audio/pinkcat.mp3';

    //初始化部分
    var data_model = [{
            'name': '爱酱',
            'path': 'model/kizunaai/kizunaai.pmx',
            'choose': true,
        },
        {
            'name': '天津风',
            'path': 'model/amatsukaze/天津風.pmx',
            'choose': false,
        },

        {
            'name': 'Lat Miku',
            'path': 'model/miku_lat/mikuVer2.31_Normal.pmd',
            'choose': false,
        },
        {
            'name': '蕾米莉亚',
            'path': 'model/remilia/remilia1.pmx',
            'choose': false,
        },
        {
            'name': 'Ruby',
            'path': 'model/ruby-chan/Ruby-chan.pmd',
            'choose': false,
        },
    ];
    var data_vmd = [{
            'name': 'Pink Cat',
            'path': ['vmd/pinkcat.vmd'],
            'musik': 'audio/pinkcat.mp3',
            'choose': true,
        },
        {
            'name': '右肩の蝶',
            'path': ['vmd/youjiannodie.vmd'],
            'musik': 'audio/youjiannodie.mp3',
            'choose': false,
        },
        {
            'name': '炉心融解',
            'path': ['vmd/luxinrongjie.vmd'],
            'musik': 'audio/luxinrongjie.mp3',
            'choose': false,
        },
        {
            'name': '深海少女',
            'path': ['vmd/Deep Sea Girl.vmd'],
            'musik': 'audio/shenhaishaonv.mp3',
            'choose': false,
        },
        {
            'name': 'Masked bitch',
            'path': ['vmd/Masked bitch.vmd'],
            'musik': 'audio/Masked bitch.mp3',
            'choose': false,
        },
    ];
    var data_background = [{
        'name': '233',
        'path': 'bg/233',
        'choose': true,
    }];
    //初始化素材数组

    init();
    animate();

    //rerender();

    function init() {
        //创建场景和隐藏的audio标签
        hover = document.createElement('div');
        loader = document.createElement('span');
        hover.setAttribute('id', 'hover');

        container = document.createElement('div');
        container.setAttribute('id', 'mmd');

        document.getElementById("box").appendChild(container);
        //画面初始化
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);
        camera.position.z = 30;
        // 视角
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff);
        var gridHelper = new THREE.PolarGridHelper(30, 10);
        gridHelper.position.y = -10;
        var ambient = new THREE.AmbientLight(0x666666);
        scene.add(ambient);
        var directionalLight = new THREE.DirectionalLight(0x887766);
        directionalLight.position.set(-1, 1, 1).normalize();
        scene.add(directionalLight);
        //
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth / 1, window.innerHeight / 1);
        container.appendChild(renderer.domElement);
        effect = new THREE.OutlineEffect(renderer);
        // STATS
        stats = new Stats();
        //container.appendChild( stats.dom );//左上角帧数监视器
        // model
        var onProgress = function(xhr) {
            if (xhr.lengthComputable) {
                var percentComplete = xhr.loaded / xhr.total * 100;
                if (percentComplete == 100) {
                    onLoadComplete();
                }
                onLoadPersent(percentComplete);
            }
        };
        var onError = function(xhr) {};
        helper = new THREE.MMDHelper();
        var loader = new THREE.MMDLoader();
        loader.load(modelFile, vmdFiles, function(object) {
            mesh = object;
            mesh.position.y = -10;
            scene.add(mesh);
            helper.add(mesh);
            helper.setAnimation(mesh);
            /*
             * Note: create CCDIKHelper after calling helper.setAnimation()
             */
            ikHelper = new THREE.CCDIKHelper(mesh);
            ikHelper.visible = false;
            scene.add(ikHelper);
            /*
             * Note: You're recommended to call helper.setPhysics()
             *       after calling helper.setAnimation().
             */
            helper.setPhysics(mesh);
            physicsHelper = new THREE.MMDPhysicsHelper(mesh);
            physicsHelper.visible = false;
            scene.add(physicsHelper);
            helper.unifyAnimationDuration({ afterglow: 2.0 });
        }, onProgress, onError);
        var controls = new THREE.OrbitControls(camera, renderer.domElement);
        window.addEventListener('resize', onWindowResize, false);
        var phongMaterials;
        var originalMaterials;

        function makePhongMaterials(materials) {
            var array = [];
            for (var i = 0, il = materials.length; i < il; i++) {
                var m = new THREE.MeshPhongMaterial();
                m.copy(materials[i]);
                m.needsUpdate = true;
                array.push(m);
            }
            phongMaterials = array;
        }
    }

    function onWindowResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        effect.setSize(window.innerWidth / 1, window.innerHeight / 1);
    }
    //
    function animate() {
        requestAnimationFrame(animate);
        stats.begin();
        render();
        stats.end();
    }

    function render() {
        helper.animate(clock.getDelta());
        if (physicsHelper !== undefined && physicsHelper.visible) physicsHelper.update();
        if (ikHelper !== undefined && ikHelper.visible) ikHelper.update();
        effect.render(scene, camera);
    }

    function rerender() {
        //重播先删除再重建画面和音乐播放器
        var mmd = document.getElementById('box');
        audioplayer.pause();

        $('canvas').remove();
        $(audioplayer).remove();
        init();
        animate();
        setTimeout("musik_player()",1000);
    }

    function musik_player() {
        audioplayer = document.createElement('audio');
        audioplayer.setAttribute('id', 'player');
        audioplayer.setAttribute('autoplay', 'autoplay');
        audioplayer.src = audioFiles;
        audioplayer.style.display = "none";
        document.body.appendChild(audioplayer);
        audioplayer.play();
    }
    /**function start() {

    }**/
    function onLoadComplete() {
        if (document.getElementById('hover')) {
                document.body.removeChild(document.getElementById('hover'));
        }

    }
    //初始化侧边栏的内容
    $('#model_choise').ready(function() {
        console.log('model ready');
        for (i in data_model) {
            if (data_model[i].choose) {
                $('#model_choise').append('<li class="active"><a href="#" onclick="model_change(' + i + ')">' + data_model[i].name + "</a></li>")
            } else {
                $('#model_choise').append('<li><a href="#" onclick="model_change(' + i + ')">' + data_model[i].name + "</a></li>")
            }
        };
    });
    $('#vmd_choise').ready(function() {
        console.log('vmd ready');
        for (i in data_vmd) {
            if (data_vmd[i].choose) {
                $('#vmd_choise').append('<li class="active"><a href="#" onclick="vmd_change(' + i + ')">' + data_vmd[i].name + "</a></li>")
            } else {
                $('#vmd_choise').append('<li><a href="#" onclick="vmd_change(' + i + ')">' + data_vmd[i].name + "</a></li>")
            }
        };
    });
    $('#background_choise').ready(function() {
        console.log('background ready');
        for (i in data_background) {
            if (data_background[i].choose) {
                $('#background_choise').append('<li class="active"><a href="#" onclick="background_change(' + i + ')">' + data_background[i].name + '</a></li>')
            } else {
                $('#background_choise').append('<li><a href="#" onclick="background_change(' + i + ')">' + data_background[i].name + '</a></li>')
            }
        }
    })
    //初始化侧边栏结束

    function onLoadPersent(persent) {}

    //处理素材选择部分开始
    function model_change(x) {
        console.log('model changed,rerend page.');
        modelFile = data_model[x].path;
        for (i in data_model) {
            data_model[i].choose = false;
        }
        data_model[x].choose = true
        rerender();
    }

    function vmd_change(x) {
        console.log('motion changed,rerend page.');
        vmdFiles = data_vmd[x].path;
        audioFiles = data_vmd[x].musik;
        for (i in data_vmd) {
            data_vmd[i].choose = false;
        }
        data_vmd[x].choose = true;
        rerender();
    }

    function background_change(x) {
        console.log('background changed,rerend page');
        bgFiles = data_background[x].path;
        for (i in data_background) {
            data_background[i].choose = false;
        }
        data_background[x].choose = true;
        rerender();
    }
    //处理素材选择部分结束
    $(window).on('load',function(){
        setTimeout('musik_player()', 800);
    });
    </script>
</body>

</html>
